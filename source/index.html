<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>CoreIR-Uplink</title>
		<link rel="stylesheet" href="index.css">
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	</head>
	<body style="background-color: #aaa">
		<div class="container">
			<section class="main">
				<div class="page-header" align="center">
			  	<h1 style="color: #333;">CoreIR-Uplink</h1>
				</div>
				<div class="row">
					<div class="col-xs-10 col-xs-offset-1" align="center">
						<div class="panel panel-default">
							<div class="panel-heading">Enter a 7 digit ID number and save it to your CoreIR transponder:</div>
	  					<div class="panel-body">
							<div class="input-group">
								<input type="text" class="form-control" readonly="readonly" placeholder="Click 'Get current ID' to read existing ID from transponder">
								<span class="input-group-btn">
									<button class="btn btn-success" type="button" onclick="readID()">Get current ID</button>
								</span>
							</div><!-- /input-group -->
								<br/><br/>
								<div class="input-group">
									<input type="text" class="form-control" placeholder="Set a new ID Number (7 digits)">
									<span class="input-group-btn">
										<button class="btn btn-danger" type="button">Save new ID</button>
									</span>
								</div><!-- /input-group -->
						  </div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-10 col-xs-offset-1" align="center">
						<div class="panel panel-default">
							<div class="panel-heading">Download the latest version of CoreIR and send it to your device</div>
							<div class="panel-body">
								<div class="col-xs-5 col-xs-offset-1">
								<button class="btn btn-success btn-lg" onclick="downloadHex()">Download latest version</button>
							</div>
									<div class="col-xs-5 col-xs-offset-1">
								<button class="btn btn-danger btn-lg" onclick="flashme()">Update!</button>
							</div>
							</div>
						</div>
					</div>
				</div>
			</section>
			<footer></footer>
			<script>
				var download = require('download-file');
				function downloadHex() {
					var url = "https://raw.githubusercontent.com/slacker87/CoreIR/master/CoreIR.hex";
					var options = {
    				directory: "./downloads/hex/",
    				filename: "CoreIR.hex"
					};
					download(url, options, function(err){
    				if (err) throw err
	    				console.log("Failed to download");
					});
				};
			</script>
			<script>
				//fire up AVRGirl and start flashing files
				var Avrgirl = require('avrgirl-arduino');


				Avrgirl.list(function(err, ports) {
				  console.log(ports);
				  /*
				  [ { comName: '/dev/cu.usbmodem1421',
				       manufacturer: 'Arduino (www.arduino.cc)',
				      serialNumber: '55432333038351F03170',
				      pnpId: '',
				      locationId: '0x14200000',
				      vendorId: '0x2341',
				      productId: '0x0043',
				      _standardPid: '0x0043' } ]
				  */
				});
			</script>
			<script>
				var Avrgirl = require('avrgirl-arduino');
				function flashme() {
				var avrgirl = new Avrgirl({
				  board: 'leonardo',
  				port: 'COM12',
				  // turn on debug mode!
				  debug: true
				});

				avrgirl.flash('./downloads/hex/CoreIR.hex', function (error) {
				  if (error) {
				    console.error(error);
				  } else {
				    console.info('done.');
				  }
				});
				};
			</script>
			<script>
				var SerialPort = require("serialport");
				var chips = require('avrgirl-chips-json');
				var stk500v2 = require('avrgirl-stk500v2');

function readID() {
var sp = new SerialPort('COM12', {
  baudrate: 9600,
	autoOpen: false,
	parser: SerialPort.parsers.raw
});

var micro = {
  "name": "ATmega32U4",
  "timeout": 200,
  "stabDelay": 100,
  "cmdexeDelay": 25,
  "syncLoops": 32,
  "byteDelay": 0,
  "pollIndex": 3,
  "pollValue": 83,
  "preDelay": 1,
  "postDelay": 1,
  "pgmEnable": [172, 83, 0, 0],
  "erase": {
    "cmd": [172, 128, 0, 0],
    "delay": 55,
    "pollMethod": 1
  },
  "flash": {
    "write": [64, 76, 0],
    "read": [32, 0, 0],
    "mode": 65,
    "blockSize": 128,
    "delay": 6,
    "poll2": 0,
    "poll1": 0,
    "size": 32768,
    "pageSize": null,
    "pages": null,
    "addressOffset": null
  },
  "eeprom": {
    "write": [193, 194, 0],
    "read": [160, 0, 0],
    "mode": 65,
    "blockSize": 4,
    "delay": 20,
    "poll2": 0,
    "poll1": 0,
    "size": 1024,
    "pageSize": 4,
    "pages": 256,
    "addressOffset": 0
  },
  "sig": [30, 149, 135],
  "signature": {
    "size": 3,
    "startAddress": 0,
    "read": [48, 0, 0, 0]
  },
  "fuses": {
    "startAddress": 0,
    "write": {
      "low": [172, 160, 0, 0],
      "high": [172, 168, 0, 0],
      "ext": [172, 164, 0, 0]
    },
    "read": {
      "low": [80, 0, 0, 0],
      "high": [88, 8, 0, 0],
      "ext": [80, 8, 0, 0]
    }
  }
};

var options = {
  comm: sp,
  chip: micro,
  frameless: false,
	debug: true
}
console.log(sp.isOpen());
sp.open();
sp.on('open', function() {
var stk = new stk500v2(options);
console.log(sp.isOpen());
stk.getSignature(function(error, signature) {
  console.log(signature);
});
});
};
			</script>
		</div>
	</body>
</html>
